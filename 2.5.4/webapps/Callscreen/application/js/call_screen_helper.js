
(function(exports){'use strict';var CallScreenHelper=function(){this.telephony=window.navigator.mozTelephony;this.Actions={ConnectingCall:{menuName:'inCallParams'},FirstCall:{menuName:'incommingCall'},FirstRttCall:{menuName:'incommingRttCall'},FirstVTCall:{menuName:'incommingVTCall'},InCall:{menuName:'inActiveCallParams'},InCallNotSupportVT:{menuName:'inActiveCallNotSupportVTParams'},InConnectingVTCall:{menuName:'InConnectingVTCallParams'},InVTCall:{menuName:'inVTCallParams'},InRttCall:{menuName:'inRttCallParams'},InHeldCall:{menuName:'inHeldCallParams'},InCall_IncommingCall:{menuName:'inCallAnswerOrHoldParams'},InCall_EndAndAnswerCall:{menuName:'inCallEndAndAnswerParams'},ConferenceGroup:{menuName:'inConfernceCallParams'},inActiveConferenceGroup:{menuName:'inActiveConfernceCallParams'},HeldConferenceGroup:{menuName:'inHeldConfernceCallParams'},InCallTwoLines:{menuName:'inCallTwoLinesParams'},InCallTwoLinesActiveRtt:{menuName:'inCallTwoLinesActiveRttParams'},InCall_CDMAconnectedAndHold:{menuName:'InCall_CDMAswitchCalls'},InCall_ManageCallGSM:{menuName:'manageCallGSM'},InCall_ManageCallVoLTE:{menuName:'manageCallVoLTE'},InConferenceTwoLines:{menuName:'inConferenceTwoLinesParams'},InCall_menuDialogOption:{menuName:'menuDialogParams'},InCall_DailerHelperOption:{menuName:'dialerHelperOption'},InCall_DailerHelperCommandModeOption:{menuName:'dialerHelperCommandModeOption'},InCall_DtmfScreenOption:{menuName:'dtmfScreenOption'},InCall_rttViewOption:{menuName:'rttViewParams'},InCall_LockScreenOption:{menuName:'lockScreenParams'},finalCallEnd:{menuName:'finalCallEndParams'}};this.Flags={'conferenceGroup':1,'incoming':2,'connected':4,'holding':8,'rejected':16,'pending':32,'alerting':64,'dialing':128,'held':256,'flag7':512,'resuming':1024};};CallScreenHelper.prototype.showGroupCallsOptions=function(){if(this.telephony.calls.length||CallsHandler.imsRegState==='voice-over-cellular'||CallsHandler.imsRegState==='voice-over-wifi'||CallsHandler.imsRegState==='video-over-cellular'||CallsHandler.imsRegState==='video-over-wifi'){this._show(this.Actions.InCall_ManageCallVoLTE);}
else{this._show(this.Actions.InCall_ManageCallGSM);}};CallScreenHelper.prototype.showMenuDialogOptions=function(){this._show(this.Actions.InCall_menuDialogOption);};CallScreenHelper.prototype.showDailerHelperOption=function(){this._show(this.Actions.InCall_DailerHelperOption);};CallScreenHelper.prototype.showDailerHelperCommandModeOption=function(){this._show(this.Actions.InCall_DailerHelperCommandModeOption);};CallScreenHelper.prototype.showLockScreenOption=function(){this._show(this.Actions.InCall_LockScreenOption);};CallScreenHelper.prototype.showRttViewOption=function(){this._show(this.Actions.InCall_rttViewOption);};CallScreenHelper.prototype.showDtmfScreenOption=function(){this._show(this.Actions.InCall_DtmfScreenOption);};CallScreenHelper.prototype.finalCallEndOption=function(){this._show(this.Actions.finalCallEnd);};CallScreenHelper.prototype.getCall=function(state){return this.telephony.calls.find(call=>call.state===state);};CallScreenHelper.prototype.CLASS_NAME='CallScreenHelper';CallScreenHelper.prototype._show=function(action,mode){var dialer=document.getElementById('dialer-helper');if(dialer&&dialer.classList.contains('display')){action=this.Actions.InCall_DailerHelperOption;mode=undefined;}
this._showMenu(action);if(mode!==undefined){CallScreen.updateCallScreenMode(mode);}};CallScreenHelper.prototype._showMenu=function(action){if(action.menuName){if(!CallScreen.bluetoothMenu.classList.contains('display')||(action.menuName==='menuDialogParams')){OptionHelper.show(action.menuName);}}else{console.log('OptionHelper.hide() for softkeypanel not implemented');}};CallScreenHelper.prototype.endAllCalls=function(){this.telephony.calls.forEach(function(call){call.hangUp();});};CallScreenHelper.prototype.setState=function(state){this.cdmaState=state;};CallScreenHelper.prototype.showCDMAitem=function(state){switch(state){case('connected_waiting'):this._show(this.Actions.InCall_IncommingCall,'min-mode');break;case('connected_hold'):this._show(this.Actions.InCall_CDMAconnectedAndHold,'list-mode');break;}};CallScreenHelper.prototype.getMode=function(){return CallScreen.getNodeNum()>1?'list-mode':'max-mode';};CallScreenHelper.prototype.render=function(){if(CallScreen.isDtmfNumberShown()){return;}
CallScreen.showMainCallscreen();if(this.cdmaState){this.showCDMAitem(this.cdmaState);return;}
this._debugCall('render');if(this.telephony.calls.length>2){console.log('Warning, this.telephony.calls.length: '+this.telephony.calls.length);this._debugCall('calls.length > 2');}
var lastMode=CallScreen.calls.getAttribute('show-mode');var callStateMask=0;if(this.telephony.conferenceGroup.calls.length>0||this.telephony.conferenceGroup.state){callStateMask=this.Flags['conferenceGroup'];callStateMask=callStateMask|this.Flags[this.telephony.conferenceGroup.state];}
callStateMask=callStateMask|this._getCallMask(this.telephony.calls);switch(callStateMask){case(this.Flags['conferenceGroup']):this._show(this.Actions.ConferenceGroup,this.getMode());break;case(this.Flags['held']|this.Flags['connected']|this.Flags['incoming']):this._show(this.Actions.InCall_EndAndAnswerCall,'list-mode');break;case(this.Flags['incoming']|this.Flags['conferenceGroup']):case(this.Flags['incoming']|this.Flags['conferenceGroup']|this.Flags['connected']):case(this.Flags['incoming']|this.Flags['conferenceGroup']|this.Flags['held']):this._show(this.Actions.InCall_IncommingCall,this.getMode());break;case(this.Flags['incoming']|this.Flags['conferenceGroup']|this.Flags['connected']|this.Flags['held']):this._show(this.Actions.InCall_EndAndAnswerCall,'list-mode');break;case(this.Flags['incoming']):if(this.telephony.calls.length==1){if(this.telephony.calls[0].videoCallState==='Bidirectional'){this._show(this.Actions.FirstVTCall,'max-mode');}else if(this.telephony.calls[0].rttMode==='full'){this._show(this.Actions.FirstRttCall,'max-mode');}else{this._show(this.Actions.FirstCall,'max-mode');}}else{this._debugCall('incomming call more that one');}
break;case(this.Flags['connected']):if(CallsHandler.isVideoCall()){this._show(this.Actions.InVTCall,'max-mode');}else if(this.telephony.calls[0].rttMode==='full'){this._show(this.Actions.InRttCall,this.getMode());}else{if(CallsHandler.isSupportedVT()){var handledCallNode=document.getElementById('list-call');if(handledCallNode.querySelector('.local-video-view').classList.contains('full')){this._show(this.Actions.InConnectingVTCall,'max-mode');}else{this._show(this.Actions.InCall,this.getMode());}}else{this._show(this.Actions.InCallNotSupportVT,this.getMode());}}
break;case(this.Flags['held']):this._show(this.Actions.InHeldCall,this.getMode());break;case(this.Flags['connected']|this.Flags['conferenceGroup']):this._show(this.Actions.inActiveConferenceGroup,this.getMode());break;case(this.Flags['held']|this.Flags['conferenceGroup']):this._show(this.Actions.HeldConferenceGroup,this.getMode());break;case(this.Flags['connected']|this.Flags['incoming']):case(this.Flags['held']|this.Flags['incoming']):this._show(this.Actions.InCall_IncommingCall,this.getMode());break;case(this.Flags['dialing']):case(this.Flags['alerting']):if(this.telephony.calls.length===1){let handledCallNode=document.getElementById('list-call');if(handledCallNode&&handledCallNode.querySelector('.local-video-view').classList.contains('full')){this._show(this.Actions.InConnectingVTCall,'max-mode');}else{this._show(this.Actions.ConnectingCall,this.getMode());}}else{this._debugCall('alerting call more that one');}
break;case(this.Flags['dialing']|this.Flags['held']):case(this.Flags['alerting']|this.Flags['held']):case(this.Flags['resuming']|this.Flags['connected']):case(this.Flags['dialing']|this.Flags['held']|this.Flags['conferenceGroup']):case(this.Flags['alerting']|this.Flags['held']|this.Flags['conferenceGroup']):this._show(this.Actions.ConnectingCall,'list-mode');break;case(this.Flags['connected']|this.Flags['held']):case(this.Flags['connected']|this.Flags['held']|this.Flags['conferenceGroup']):case(this.Flags['connected']|this.Flags['holding']):if(CallsHandler.isFirstCallOnCdmaNetwork()){this._show(this.Actions.InCall_CDMAconnectedAndHold,'list-mode');}else if(this.telephony.conferenceGroup.state==="connected"){this._show(this.Actions.InConferenceTwoLines,'list-mode');}else if(CallsHandler.isConnectedCallInRttMode){this._show(this.Actions.InCallTwoLinesActiveRtt,'list-mode');}else{this._show(this.Actions.InCallTwoLines,'list-mode');}
break;default:break;}
console.log('callStateMask: '+callStateMask.toString(2)+', '+this._callMaskToString(callStateMask));CallScreen.handleCallWaitingScreen();if(lastMode!==CallScreen.calls.getAttribute('show-mode')){CallScreen.updateHeldDisplay();}};CallScreenHelper.prototype._callMaskToString=function(mask){var result='';for(var key in this.Flags){if(this.Flags.hasOwnProperty(key)){if(this.Flags[key]&mask){result+='<'+key+'> ';}}}
return result;};CallScreenHelper.prototype._debugCall=function(message){console.log('calls('+message+'):');this.telephony.calls.forEach(function(call){console.log('call \tnumber:<'+call.id.number+'>,  state:<'+call.state+'>, '+', name: <'+call.id.number+'>');});this.telephony.conferenceGroup.calls.forEach(function(call){console.log('conCall \tnumber:<'+call.id.number+'>');});};CallScreenHelper.prototype._getCallMask=function(calls){var self=this;var callStateMask=0;calls.forEach(function(call){callStateMask=callStateMask|self.Flags[call.state];});return callStateMask;};exports.CallScreenHelper=new CallScreenHelper();})(window);