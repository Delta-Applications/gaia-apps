webpackJsonp([0],{30:function(e,exports,t){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),s=t(3),c=n(s),l=t(10),u=n(l),d=t(5),f=n(d),p=t(39),h=n(p),m=t(11),v=n(m),g=t(304),y=n(g),b=t(308),E=n(b),w=t(22),_=n(w),O=t(25),k=n(O),C=function(e){function n(e){a(this,n);var t=i(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.name="EditView",t.DEBUG=!1,t.FOCUS_SELECTOR=".navigable",t.state={contact:null,target:""},window.editview=t,t}return o(n,e),r(n,[{key:"componentDidMount",value:function(){var e=this;this.debug("did mount: id:",this.props.id),"new"===this.props.id&&h.default.measure("enter-new-contact"),this.element=u.default.findDOMNode(this),this.props.id?this.props.tel||this.props.email||this.props.photo||this.props.name?v.default.getWrappedContact(this.props.id,this.props).then(function(t){e.setState({contact:t})}):v.default.getWrappedContact(this.props.id).then(function(t){e.setState({contact:t})}):this.props.blob&&k.default.fromVcard(this.props.blob).then(function(t){var n=new _.default(t);v.default.wrappedContactMap.set(n.id,n),e.setState({contact:n})}),Promise.resolve().then(function(){return t(307)})}},{key:"componentWillUnmount",value:function(){"new"===this.props.id&&v.default.wrappedContactMap.delete("new")}},{key:"componentDidUpdate",value:function(){this.onFocus()}},{key:"onFocus",value:function(){document.activeElement===this.element&&this.refs.editor&&u.default.findDOMNode(this.refs.editor).focus()}},{key:"chooseMemory",value:function(){var e=this;k.default.chooseMemory().then(function(t){t?e.setState({target:t}):k.default.backOrClose()})}},{key:"render",value:function(){var e=this,t=this.props.id&&"new"!==this.props.id?"edit-title":"new-contact-title",n=null;if(this.state.contact)if(this.props.target||this.state.target||"new"!==this.props.id){var a=this.props.target||this.state.target||"";n=a.startsWith("sim")?c.default.createElement(E.default,{ref:"editor",heading:t,contact:this.state.contact,target:a}):k.default.isSIMContact(this.state.contact.contact)?c.default.createElement(E.default,{ref:"editor",heading:t,contact:this.state.contact,target:a}):c.default.createElement(y.default,{ref:"editor",heading:t,contact:this.state.contact})}else this.chooseMemory();return c.default.createElement("div",{id:"edit-view",tabIndex:"-1",onFocus:function(t){return e.onFocus(t)}},c.default.createElement("div",{className:"header h1","data-l10n-id":t}),n)}}]),n}(f.default);exports.default=C,C.propTypes={id:c.default.PropTypes.string}},302:function(e,exports,t){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),s=t(38),c=n(s),l=t(8),u=n(l),d=t(4),f=n(d),p=function(e){function t(){a(this,t);var e=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.name="Voicemail",e.DEBUG=!1,e.values=[],c.default.addObserver("ril.iccInfo.mbdn",e),e}return o(t,e),r(t,[{key:"getValues",value:function(){return[].concat(this.values)}},{key:"set",value:function(e){c.default.set({"ril.iccInfo.mbdn":Array.isArray(e)?e:[e]}),f.default.request("ToastManager:show",{text:navigator.mozL10n.get("voice-mail-number-updated")})}},{key:"_observe_ril.iccInfo.mbdn",value:function(e){this.debug("detect voicemail changed:",e);var t=navigator.mozMobileConnections.length;this.values=Array.isArray(e)?e:[e],this.values=this.values.map(function(e,n){if(!(n>=t))return e||navigator.mozVoicemail.getNumber(n)}),this.emit("changed")}}]),t}(u.default),h=new p;window.vm=h,exports.default=h},304:function(e,exports,t){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),c=t(3),l=n(c),u=t(10),d=n(u),f=t(5),p=n(f),h=t(21),m=n(h),v=t(4),g=n(v),y=t(24),b=n(y),E=t(38),w=n(E),_=t(305),O=t(29),k=t(22),C=t(11),S=n(C),N=t(25),D=n(N);t(309);var I={email:"personal",tel:"mobile",adr:"home"},T=function(e){function t(e){a(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.name="ContactEditor",n.DEBUG=!1,n.FOCUS_SELECTOR=".navigable:not(.hidden),.button",n.SCROLL_SELECTOR=".list-item",n.blobs=new Map,n.state={fields:n.props.contact.dataMap},window.editor=n,n.utils=D.default,n._onFieldChanged=n._onFieldChanged.bind(n),n.isEditFiledType=!1,n}return o(t,e),s(t,[{key:"componentDidMount",value:function(){var e=this;this.debug("did mount"),window.editor=this,this.element=d.default.findDOMNode(this),this.navigator=new b.default(this.FOCUS_SELECTOR,this.element,this.SCROLL_SELECTOR),this.updateSoftKeys(),this.props.contact.on("fieldchanged",this._onFieldChanged),this.defaultRingtone="",w.default.get("dialer.ringtone.id").then(function(t){e.defaultRingtone=t});var t=this.props.contact.contact.ringtone;D.default.checkRingTone(t).then(function(t){t||e.props.contact.removeField("ringtone",0)})}},{key:"_onFieldChanged",value:function(e,t){var n=this;this.debug("_onFieldChanged:",e,t),this.setState({fields:this.props.contact.dataMap},function(){"add"===e?"photo"===t?n.pickImage():"ringtone"===t?n.changeRingtone():window.setTimeout(function(){var e=t+"-"+(n.state.fields.get(t).length-1)+"-input";n.debug("to focus the input ref:",e),n.navigator.setFocus(d.default.findDOMNode(n.refs[e]),n.isEditFiledType),n.isEditFiledType=!1}):"photo"===t&&n.blobs.delete("photo-0"),n.updateSoftKeys()})}},{key:"changeRingtone",value:function(){var e=this,t=new window.MozActivity({name:"pick",data:{type:["audio/*","ringtone"],allowNone:!1,currentToneID:this.currentRingtone||this.defaultRingtone}});t.onsuccess=function(){var n=t.result;if(!n.id&&!n.blob)return void e._resetField("ringtone");var a=d.default.findDOMNode(e.refs["ringtone-0"]);a.querySelector(".primary").textContent=n.name,a.classList.remove("hidden"),a.dataset.value=n.id||n.blob.name,a.dataset.filename=n.blob.name||n.filename,e.navigator.setFocus(a)},t.onerror=function(){e._resetField("ringtone")}}},{key:"_resetField",value:function(e){this.debug("_resetField:",e),this.getInputData()[e]||this.props.contact.removeField(e,0)}},{key:"componentWillUnmount",value:function(){this.navigator.destroy(),this._softKey.destroy(),this.props.contact.off("fieldchanged",this._onFieldChanged)}},{key:"pickImage",value:function(){var e=this,t=new window.MozActivity({name:"pick",data:{type:"image/jpeg"}}),n=this;t.onsuccess=function(){var e=this.result.blob;if(e){var t=d.default.findDOMNode(n.refs["photo-0"]);t.classList.remove("hidden"),n.navigator.setFocus(t);var a=Math.min(t.clientWidth,t.clientHeight);D.default.drawPhoto(e,null,a,function(e){t.style.backgroundImage="url("+URL.createObjectURL(e),n.blobs.set("photo-0",e)})}else void 0!==e?(n.navigator.setFocus(n.navigator.findNext(document.activeElement)),n.props.contact.removeField("photo",0)):document.activeElement.classList.contains("photo")||n._resetField("photo")},t.onerror=function(){e._resetField("photo")}}},{key:"clear",value:function(){g.default.query("isActivity")||(Array.from(this.element.querySelectorAll("input")).forEach(function(e){e.value="";var t=e.previousElementSibling.classList;t.contains("visible")&&t.remove("visible")}),this.navigator.setFocus(this.element.querySelector("input"),!0),this.blobs.clear())}},{key:"updateSoftKeys",value:function(){var e=this.isChanged()&&!this.isEmpty(),t={left:"cancel",right:"options"};e&&(t.center="save"),g.default.query("isLowMemoryDevice")&&"tel"!==document.activeElement.dataset.field&&(t.right=""),document.activeElement===d.default.findDOMNode(this.refs.add)&&(t.center="select",t.right=""),this._softKey=m.default.create(this.element,t)}},{key:"backOrClose",value:function(){this.debug("back"),this._isGoingBack=!0,g.default.query("isActivity")?setTimeout(function(){g.default.request("leaveActivity")},0):(this.clear(),g.default.request("back"))}},{key:"onKeyDown",value:function(e){var t=this,n=document.activeElement,a=n.querySelector("label")||n.previousElementSibling,i=a?a.textContent:"",o=navigator.mozL10n.get,r=[];if(!this._isGoingBack)switch(e.key){case"Enter":if(document.activeElement===d.default.findDOMNode(this.refs.add))return void(g.default.query("isLowMemoryDevice")?this.props.contact.addField("tel",I.tel):g.default.request("popup","/add/"+this.props.contact.id).catch(function(e){}));if(!this.isChanged()||this.isEmpty())return;this.save();break;case"Backspace":case"SoftLeft":if(e.preventDefault(),e.stopPropagation(),"Backspace"===e.key&&"INPUT"===n.tagName&&""!==n.value)return;if(this.isChanged()){if(this.isEmpty())return void g.default.request("showDialog",{header:"confirm",content:"discard-contact-data",ok:"discard",onOk:function(){t._isGoingBack=!0,t.props.contact.normalize(),t.backOrClose()}});var s="new"===this.props.contact.id?"confirm-discard-contact-data":"confirm-discard-contact-update-data";g.default.request("showDialog",{header:"confirm",content:s,type:"custom",buttons:[{message:"cancel"},{message:"save"},{message:"discard"}],onOk:function(e){2===e.selectedButton?(t._isGoingBack=!0,t.props.contact.normalize(),t.backOrClose()):1===e.selectedButton&&t.save()}})}else this.backOrClose();break;case"SoftRight":if(e.preventDefault(),e.stopPropagation(),document.activeElement===d.default.findDOMNode(this.refs.add))break;if(n.classList.contains("photo")&&(r.push({id:"replace-photo",callback:function(){t.pickImage()}}),r.push(this._createDeletionOption("photo",o("delete-photo-msg")))),n.classList.contains("ringtone")&&(r.push({id:"replace-ringtone",callback:function(){t.changeRingtone()}}),r.push(this._createDeletionOption("ringtone",o("delete-"+i.toLowerCase()+"-msg")))),"INPUT"===n.tagName||"bday"===n.dataset.field){var c=n.dataset.index,l=n.dataset.field;if(n.dataset.type&&r.push({id:"edit-"+l+"-type",callback:function(){"bday"===l?t.navigator.setFocus(n.querySelector("input")):(t.isEditFiledType=!0,g.default.request("popup","/type/"+t.props.contact.id+"/"+l+"/"+c+"/"+n.dataset.type))}}),"false"!==n.dataset.removable){var u=["bday","note","org"];"adr"===l&&(i=D.default.isCustomTag(l,n.dataset.type)?o("custom-"+l,{type:n.dataset.type}):o(n.dataset.type+"-"+l,{type:n.dataset.type})),u.includes(l)&&(i=o("delete-"+l+"-msg")),r.push(this._createDeletionOption(l,i,c))}"bday"!==l&&"ringtone"!==l&&"givenName"!==l&&"familyName"!==l&&"note"!==l&&r.push({id:"tel"===l?"add-"+l+"-number":"add-"+l,callback:function(){if("org"!==l&&"note"!==l){var e=I[l];e?t.props.contact.addField(l,e):g.default.request("popup","/type/"+t.props.contact.id+"/"+l)}else t.props.contact.addField("org")}})}g.default.query("isLowMemoryDevice")||r.push({id:"add-others",callback:function(){g.default.request("popup","/add/"+t.props.contact.id)}}),r.length&&g.default.request("showOptionMenu",{options:r,onCancel:function(){}})}}},{key:"_createDeletionOption",value:function(e,t){var n=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=navigator.mozL10n.get,o=Array.from(this.element.querySelectorAll(this.FOCUS_SELECTOR)),r=this.navigator.getElementIndex(document.activeElement),s=0===r?o[1]:this.navigator.findPrev(document.activeElement);if("adr"===document.activeElement.dataset.field){var c=Number(document.activeElement.dataset.index);if(c>0)s=this.element.querySelectorAll("[data-index='"+--c+"'][data-field='adr']")[0];else for(;"adr"===s.dataset.field;)s=this.navigator.findPrev(s)}return{id:"delete-"+e,callback:function(){g.default.request("showDialog",{header:i("confirm"),content:i("delete-prompt-message",{field:t}),ok:"delete",type:"confirm",translated:!0,onOk:function(){n.props.contact.removeField(e,a),n.navigator.setFocus(s)}})}}}},{key:"isSIMcontact",value:function(){return this.props.target&&this.props.contact.startsWith("sim")}},{key:"onFocus",value:function(){if(this.debug("onFocus:"),this._isGoingBack=!1,this._processingSave=!1,this.updateSoftKeys(),this.element.contains(document.activeElement)&&document.activeElement!==this.element){var e=this.element.querySelector(".focus");if(e&&e.nextElementSibling.firstElementChild&&!e.nextElementSibling.firstElementChild.lastElementChild.value){var t=e.nextElementSibling.firstElementChild.firstElementChild;t.classList.remove("visibile"),void 0!==e.nextElementSibling.firstElementChild.lastElementChild.value&&t.classList.add("disvisibile")}if(e&&(e.classList.remove("focus"),e.firstElementChild.lastElementChild.placeholder=e.firstElementChild.firstElementChild.textContent,!e.firstElementChild.lastElementChild.value&&!e.firstElementChild.lastElementChild.innerText)){var n=e.firstElementChild.firstElementChild;n.classList.remove("visibile"),n.classList.add("disvisibile")}if("INPUT"===document.activeElement.tagName){var a=document.activeElement.previousElementSibling;document.activeElement.parentNode.parentNode.classList.add("focus"),a.classList.remove("disvisibile"),a.classList.add("visibile"),D.default.setCursorToEnd(document.activeElement)}else"bday"!==document.activeElement.dataset.field&&"ringtone"!==document.activeElement.dataset.field||document.activeElement.classList.add("focus")}}},{key:"getInputData",value:function(){var e={};for(var t in this.refs){var n=d.default.findDOMNode(this.refs[t]),a=n.dataset.field;if("INPUT"===n.tagName){var i=n.value.trim();if("email"===a&&(i.length&&!n.validity.valid?n.parentElement.classList.add("invalidMail"):n.parentElement.classList.remove("invalidMail")),""!==i)if("bday"===a)e[a]=new Date(i);else if("givenName"===a||"familyName"===a||"name"===a)e[a]=[i];else if("adr"===a)!function(){var t=+n.dataset.index;e.adr||(e.adr=[]);var a=n.name;if(e.adr[t])e.adr[t][a]=i;else{var o={type:[n.dataset.type]};o[a]=i,e.adr[t]=o}var r=n.dataset.type;e.adr[t].type=[r];var s={};Object.keys(e.adr[t]).sort().forEach(function(n){s[n]=e.adr[t][n]}),e.adr[t]=s}();else{var o=n.dataset.type,r={type:[o],value:i};"note"!==a&&"org"!==a||(r=i),e[a]?e[a].push(r):e[a]=[r]}}else if("photo"===a){var s=this.blobs.get(t);s&&(e.photo=[s])}else if("ringtone"===a){var c=n.dataset.value&&n.dataset.value.indexOf("builtin:ringtone/")>-1,l=c?n.dataset.value:n.dataset.filename;l?(this.currentRingtone=l,e.ringtone=l):this.currentRingtone=null}}for(var u in e)"bday"!==u&&"ringtone"!==u&&(e[u]=e[u].filter(function(e){return e}));return e}},{key:"save",value:function(){var e=this;if(!this._processingSave){this._processingSave=!0;var t=this.getInputData();D.default.isChinese(t.familyName)&&D.default.isChinese(t.givenName)?t.name=[(""+(t.familyName||"")+(t.givenName||"")).trim()]:t.name=[((t.givenName||"")+" "+(t.familyName||"")).trim()],this.props.contact&&((0,k.FIELDS)().forEach(function(n){"group"!==n&&(e.props.contact.contact[n]=t[n]||null)}),t=this.props.contact.contact),(0,_.findDup)(t).then(function(n){if(!n.length)return Promise.reject();var a=t.id||"new";return g.default.request("popup","/merge/"+a).then(function(t){if("cancel"===t[0].action)return Promise.reject();"merge"===t[0].action&&e.backOrClose()})}).catch(function(){S.default.createOrUpdate(t,!!t.id,"manual").then(function(t){g.default.request("ToastManager:show",{text:t.message}),(0,O.operateSync)(O.SYNC_OPERATION.PUSH,{contact:t.data}),e.backOrClose()})})}}},{key:"onInput",value:function(){this.updateSoftKeys()}},{key:"getInputType",value:function(e){switch(e){case"email":return"email";case"tel":case"postalCode":return"tel";case"bday":return"date";default:return"text"}}},{key:"onBlur",value:function(e){var t=e.target;if(this.debug("onBlur: type, value:",t.type,t.value),"date"===t.type){var n=t.value;if(n){var a=d.default.findDOMNode(this.refs["bday-text"]);a&&(a.textContent=D.default.unifyDateString(new Date(n))),this.navigator.setFocus(e.target.parentNode.parentNode),e.target.parentNode.parentNode.focus()}else this._resetField("bday"),this.navigator.setFocus(d.default.findDOMNode(this.refs.add)),this.element.focus()}}},{key:"isTheSame",value:function(e,t){return JSON.stringify(e)===JSON.stringify(t)}},{key:"isEmpty",value:function(){var e=this.getInputData();for(var t in e)if(e[t])return!1;return!0}},{key:"isChanged",value:function(){var e=this;if("open"===g.default.query("activityType"))return!0;var t=!1,n=this.getInputData();return(0,k.FIELDS)().some(function(a){if("group"===a)return!1;var i=e.props.contact.contact[a],o=n[a];return Array.isArray(i)||(i=[i]),Array.isArray(o)||(o=[o]),!!(i.length&&(1!==i.length||i[0])||o.length&&(1!==o.length||o[0]))&&("photo"===a&&e.blobs.get("photo-0")!==i[0]?(t=!0,!0):!e.isTheSame(o,i)&&"name"!==a&&(t=!0,!0))}),t}},{key:"render",value:function(){var e=this;this.debug("render");var t=[],n=[],a=[];this.props.heading;this.state.fields.forEach(function(e){if(e.length&&"familyName"===e[0].field){var t=a.pop();e[0].value.length||t.value.length?D.default.isChinese(e[0].value)&&D.default.isChinese(t.value)?(a=a.concat(e),a.push(t)):(a.push(t),a=a.concat(e)):navigator.language.indexOf("zh-")>-1?(a=a.concat(e),a.push(t)):(a.push(t),a=a.concat(e))}else a=a.concat(e)}),a.forEach(function(a){var i=a.field,o=a.index,s=a.type,c=a.key||i+"-"+o,u=i+"-"+o,d=a.value,f={};switch(i){case"photo":d&&(f.backgroundImage="url('"+URL.createObjectURL(d)+"')",e.blobs.set("photo-0",d)),n.push(l.default.createElement("div",{className:"list-item photo navigable "+(d?"":"hidden"),tabIndex:"-1",ref:"photo-"+o,"data-index":o,"data-field":i,style:f}));break;case"adr":t.push(l.default.createElement("div",r({className:"separator secondary",key:c+"-separator"},D.default.getFieldL10nConfig(i,s))));for(var p in d){var h="";h="streetAddress"===p?i+"-"+o:i+"-"+o+"-"+p,t.push(l.default.createElement("div",{className:"list-item",tabIndex:"-1","data-type":"input","data-field":i,key:h},l.default.createElement("div",{className:"content"},l.default.createElement("label",{className:"secondary",htmlFor:h,"data-l10n-id":p}),l.default.createElement("input",{type:e.getInputType(p),"data-index":o,"data-field":i,"data-type":s,"data-subfield":p,defaultValue:d[p],className:"navigable",name:p,ref:h+"-input",id:h+"-input",maxLength:100}))))}break;case"ringtone":t.push(l.default.createElement("div",{className:"ringtone list-item navigable "+(d?"":"hidden"),tabIndex:"-1","data-field":i,"data-value":d,"data-filename":d,"data-removable":!0,key:c,ref:"ringtone-"+o},l.default.createElement("div",{className:"content"},l.default.createElement("label",r({className:"secondary",htmlFor:"new-"+c},D.default.getFieldL10nConfig(i,s))),l.default.createElement("div",{className:"primary"},D.default.guessRingtoneName(d)))));break;default:if("name"===i||g.default.query("isLowMemoryDevice")&&"email"===i)break;t.push(l.default.createElement("div",{className:"list-item "+("bday"===i?"navigable":""),tabIndex:"-1","data-type":"input","data-field":i,key:c},l.default.createElement("div",{className:"content"},l.default.createElement("label",r({id:"new-"+c,className:"secondary "+(""===d?"disvisibile":"visibile"),htmlFor:"new-"+c},D.default.getFieldL10nConfig(i,s))),l.default.createElement("input",r({"aria-label":e.props.heading,"aria-describedby":"new-"+c,type:e.getInputType(i),"data-index":o,"data-field":i,"data-type":s,id:"new-"+i+"-"+o,className:"bday"===i?"":"navigable",name:"bday"===i?"":i,"data-removable":i.indexOf("Name")>=0||["tel","email"].includes(i)&&0===o?"false":"true",onBlur:function(t){return e.onBlur(t)},defaultValue:d},D.default.getPlaceholderConfig(i,s),{ref:u+"-input",maxLength:"tel"===i?k.MAX_TEL_LENGTH:k.MAX_TEXT_LENGTH,style:"bday"===i?{width:"0px",height:"0px",border:"0px"}:{}})),"bday"===i&&l.default.createElement("div",{ref:"bday-text",className:"primary"},d&&D.default.unifyDateString(new Date(d))))))}});var i=null;return this.isSIMcontact()||(i=l.default.createElement("div",{className:"list-item"},l.default.createElement("div",{className:"content","data-add-content":"add-content"},l.default.createElement("div",{className:"button primary",tabIndex:"-1",ref:"add","data-l10n-id":g.default.query("isLowMemoryDevice")?"add-phone":"add"})))),l.default.createElement("div",{role:"form",className:"contact-editor",tabIndex:"-1",onKeyDown:function(t){return e.onKeyDown(t)},onFocus:function(t){return e.onFocus(t)},onInput:function(t){return e.onInput(t)}},n,t,i)}}]),t}(p.default);exports.default=T,T.propTypes={contact:l.default.PropTypes.object}},305:function(e,exports,t){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports._mergeContacts=exports.merge=exports.findDup=void 0;var n=t(11),a=function(e){return e&&e.__esModule?e:{default:e}}(n),i=t(22),o=function(e){return e.category&&e.category.includes(i.CLOUD_TAG)?Promise.resolve([]):new Promise(function(t){var n=[],o=e.name&&e.name[0],r=e.tel&&e.tel.map(function(e){return e.value});a.default.getSourceContacts("phone").filter(function(e){return e.category&&!e.category.includes(i.CLOUD_TAG)}).forEach(function(t){if(t.id!==e.id)if(o&&t.name&&t.name[0]===o)n.push(t);else if(r&&t.tel){var a=t.tel.some(function(e){return r.includes(e.value)});a&&n.push(t)}}),t(n)})},r=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.fromContact,n=e.toContact,i=e.onConflict,o=["name","photo","note","bday","ringtone"].filter(function(e){return!!(n[e]&&n[e].toString()&&t[e]&&t[e].toString())&&("photo"===e?!n[e][0].name||!t[e][0].name||n[e][0].name!==t[e][0].name&&n[e][0].size!==t[e][0].size:n[e].toString()!==t[e].toString())});return new Promise(function(e){o.length&&i?i(e,o):e(!0)}).then(function(){return a.default.remove(t)}).then(function(){var e=s(t,n);return a.default.createOrUpdate(e,!0)})},s=function(e,t){var n=["name","givenName","familyName","photo","note","bday","ringtone"],a={};return(0,i.FIELDS)().forEach(function(i){if(n.includes(i))return void(a[i]=t[i]&&t[i].toString()?t[i]:e[i]);if(a[i]=[],t[i]&&(a[i]=a[i].concat(t[i])),e[i])if("tel"!==i)a[i]=a[i].concat(e[i]);else{var o=t.tel?t.tel.map(function(e){return e.value}):[];e.tel.forEach(function(e){!o.includes(e.value)&&a.tel.push(e)})}}),Object.keys(a).forEach(function(e){t[e]=a[e]&&a[e].toString()?a[e]:null}),t};exports.findDup=o,exports.merge=r,exports._mergeContacts=s},306:function(e,exports,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=t(11),o=function(e){return e&&e.__esModule?e:{default:e}}(i),r=function(){function e(t){var a=t.dial,i=void 0===a?-1:a,o=t.contact,r=void 0===o?null:o,s=t.telIndex,c=void 0===s?0:s;n(this,e),this.dial=i,this.contact=r,this.telIndex=c,this.originTel=""}return a(e,[{key:"updateByRawData",value:function(e){var t=this;return e.contactId?o.default.getContact(e.contactId).then(function(n){if(n&&n.tel){var a=void 0;if(!((a=1===n.tel.length?0:n.tel.map(function(e){return e.value}).indexOf(e.tel))<0))return t.contact=n,t.originTel=e.tel,t.telIndex=a,t}}):(this.contact={id:"",name:[""],tel:[{value:e.tel}]},this.telIndex=0,this)}},{key:"sync",value:function(){var e=this;return navigator.mozContacts.getSpeedDials().then(function(t){var n=t.filter(function(t){return+t.speedDial===e.dial})[0];return n?e.updateByRawData(n):(e.contact=null,e.telIndex=0,Promise.resolve(e))})}},{key:"tel",get:function(){return this.contact&&this.contact.tel&&this.contact.tel[this.telIndex]?this.contact.tel[this.telIndex].value:null}}]),e}();exports.default=r},307:function(e,exports,t){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),s=t(49),c=n(s),l=t(38),u=n(l),d=t(302),f=n(d),p=t(306),h=n(p),m=t(25),v=n(m),g=function(e){function t(){var e,n,o,r;a(this,t);for(var s=arguments.length,c=Array(s),l=0;l<s;l++)c[l]=arguments[l];return n=o=i(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(c))),o.SIZE=9,o.contacts=[],o.presetDialId="presetSpeedDial",o._onSpeedDialChange=function(e){o.contacts[+e.speedDial-1].sync().then(function(){o.emit("changed")})},o._onContactChanged=function(e){o.contacts.forEach(function(t){t.contact&&(e.contactID!==t.contact.id&&e.contactID||o.set(t.dial,{contact:{id:"",tel:[{value:t.originTel}]},telIndex:0}))})},r=n,i(o,r)}return o(t,e),r(t,[{key:"start",value:function(){var e=this;window.sds=this,this._initData(),this._fetch(),navigator.mozContacts.addEventListener("contactchange",this._onContactChanged),navigator.mozContacts.addEventListener("speeddialchange",this._onSpeedDialChange),u.default.get("custom.speeddials").then(function(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach(function(t){if(t){var n=t.key,a=t.name,i=t.tel;e.contacts[n-1]={dial:n,tel:i,contact:{id:e.presetDialId,name:[a]}},e.emit("changed")}})}),v.default.SUPPORT_VOICEMAIL&&f.default.on("changed",function(){e.contacts[0].tel=f.default.getValues()[0],e.emit("changed")})}},{key:"getAll",value:function(){return this.contacts}},{key:"_initData",value:function(){var e=0;this.contacts=[],v.default.SUPPORT_VOICEMAIL&&(this.contacts[e++]={dial:1,tel:f.default.getValues()[0],voicemail:!0,contact:{id:"voicemail",name:["voicemail"]}});for(var t=e;t<this.SIZE;t++)this.contacts.push(new h.default({dial:t+1}))}},{key:"_fetch",value:function(){var e=this;navigator.mozContacts.getSpeedDials().then(function(t){var n=t.map(function(t){return e.contacts[+t.speedDial-1].updateByRawData(t)});Promise.all(n).then(function(){e.emit("changed")})})}},{key:"set",value:function(e,t){var n=t.contact,a=t.telIndex;void 0===a&&(a=this.contacts[e-1].telIndex),navigator.mozContacts.setSpeedDial(e,n.tel[a].value,n.id).onerror=function(e){}}},{key:"remove",value:function(e){navigator.mozContacts.removeSpeedDial(e).onerror=function(e){}}}]),t}(c.default),y=new g;y.start(),exports.default=y},308:function(e,exports,t){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),c=t(3),l=n(c),u=t(10),d=n(u),f=t(21),p=n(f),h=t(4),m=n(h),v=t(24),g=n(v),y=t(304),b=n(y),E=t(25),w=n(E),_=t(11),O=n(_),k=["name","tel"],C=function(e){function t(e){a(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.FOCUS_SELECTOR=".navigable:not(.hidden),.button",n.SCROLL_SELECTOR=".list-item",n.blobs=new Map,n.state={fields:n.props.contact.dataMap},window.seditor=n,n.utils=w.default,n}return o(t,e),s(t,[{key:"componentDidMount",value:function(){var e=this.getConfig();window.seditor=this,this.utils=w.default,this.element=d.default.findDOMNode(this),this.navigator=new g.default(this.FOCUS_SELECTOR,this.element,this.SCROLL_SELECTOR),this._softKey=p.default.create(this.element,e)}},{key:"clear",value:function(){m.default.query("isActivity")||(Array.from(this.element.querySelectorAll("input")).forEach(function(e){e.value=""}),this.navigator.setFocus(this.element.querySelector("input"),!0))}},{key:"getConfig",value:function(){var e=this.isChanged()&&!this.isEmpty(),t={left:"cancel"};return e&&(t.center="save"),t}},{key:"updateSoftKeys",value:function(){this._softKey.update(this.getConfig())}},{key:"componentWillUnmount",value:function(){this._softKey.destroy()}},{key:"onKeyDown",value:function(e){var t=this,n=document.activeElement;if(!this._isGoingBack)switch(e.key){case"Enter":if(!this.isChanged()||this.isEmpty())return;this.save();break;case"Backspace":if(e.preventDefault(),e.stopPropagation(),"INPUT"===n.tagName&&""!==n.value)return;case"SoftLeft":if(e.preventDefault(),e.stopPropagation(),this.isChanged()){if(this.isEmpty())return void m.default.request("showDialog",{header:"confirm",content:"discard-contact-data",ok:"discard",onOk:function(){t._isGoingBack=!0,t.props.contact.normalize(),t.backOrClose()}});var a="new"===this.props.contact.id?"confirm-discard-contact-data":"confirm-discard-contact-update-data";m.default.request("showDialog",{header:"confirm",content:a,type:"custom",buttons:[{message:"cancel"},{message:"save"},{message:"discard"}],onOk:function(e){2===e.selectedButton?(t._isGoingBack=!0,t.props.contact.normalize(),t.backOrClose()):1===e.selectedButton&&t.save()}})}else this.backOrClose()}}},{key:"onFocus",value:function(){if(this._isGoingBack=!1,this._processingSave=!1,this.updateSoftKeys(),this.element.contains(document.activeElement)&&document.activeElement!==this.element){var e=this.element.querySelector(".focus");e&&e.classList.remove("focus"),"INPUT"===document.activeElement.tagName&&(document.activeElement.parentNode.parentNode.classList.add("focus"),w.default.setCursorToEnd(document.activeElement))}}},{key:"save",value:function(){var e=this;if(!this._processingSave){this._processingSave=!0;var t=this.getInputData();this.props.contact&&(k.forEach(function(n){t[n]?e.props.contact.contact[n]=t[n]:e.props.contact.contact[n]=null}),t=this.props.contact.contact),t.category&&0!==t.category.length||(t.category=["SIM",this.props.target.toUpperCase(),"KAICONTACT"]),O.default.createOrUpdate(t,!0,"manual").then(function(t){m.default.request("ToastManager:show",{text:t.message}),e.backOrClose()})}}},{key:"onInput",value:function(){this.updateSoftKeys()}},{key:"getInputType",value:function(e){switch(e){case"email":return"email";case"tel":return"tel";case"bday":return"date";default:return"text"}}},{key:"onBlur",value:function(e){var t=e.target;if("date"===t.type){t.value?(this.navigator.setFocus(e.target.parentNode.parentNode),e.target.parentNode.parentNode.focus()):(this.props.contact.removeField("bday",0),this.navigator.setFocus(d.default.findDOMNode(this.refs.add)),this.element.focus())}}},{key:"isTheSame",value:function(e,t){return JSON.stringify(e)===JSON.stringify(t)}},{key:"isChanged",value:function(){var e=this;if("open"===m.default.query("activityType"))return!0;var t=!1,n=this.getInputData();return k.some(function(a){var i=e.props.contact.contact[a],o=n[a];return Array.isArray(i)||(i=[i]),Array.isArray(o)||(o=[o]),!!(i.length&&(1!==i.length||i[0])||o.length&&(1!==o.length||o[0]))&&("photo"===a&&e.blobs.get("photo-0")!==i[0]?(t=!0,!0):!(e.isTheSame(o,i)||"name"!==a&&"tel"!==a)&&(t=!0,!0))}),t}},{key:"render",value:function(){var e=this,t=[],n=[];return this.state.fields.forEach(function(e){n=n.concat(e)}),n.forEach(function(n){var a=n.field,i=n.index,o=n.type,s=a+"-"+i,c=n.value;switch(a){case"name":case"tel":t.push(l.default.createElement("div",{className:"list-item "+("bday"===a?"navigable":""),tabIndex:"-1","data-type":"input","data-field":a,key:s},l.default.createElement("div",{className:"content"},l.default.createElement("label",r({id:"new-"+s,className:"secondary",htmlFor:"new-"+s},w.default.getFieldL10nConfig(a,o,"sim"))),l.default.createElement("input",{"aria-label":e.props.heading,"aria-describedby":"new-"+s,type:e.getInputType(a),"data-index":i,"data-field":a,"data-type":o,id:"new-"+a+"-"+i,className:"bday"===a?"":"navigable",name:a,"data-removable":a.indexOf("Name")>=0?"false":"true",onBlur:function(t){return e.onBlur(t)},defaultValue:c,ref:s+"-input",maxLength:"tel"===a?20:14}))))}}),l.default.createElement("div",{role:"form",className:"contact-editor",tabIndex:"-1",onKeyDown:function(t){return e.onKeyDown(t)},onFocus:function(t){return e.onFocus(t)},onInput:function(t){return e.onInput(t)}},t)}}]),t}(b.default);exports.default=C,C.propTypes={contact:l.default.PropTypes.object}},309:function(e,exports){}});
//# sourceMappingURL=0.bundle.js.map